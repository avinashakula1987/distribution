<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="css/init.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/userAccounts.css">
</head>
<body>


    <div clas='container-fluid'>
        <div>
            <div class="settingsMenu">
                <nav class="navbar navbar-dark bg-warning">
                    <div class="container-fluid">
                        <a class="navbar-brand" href="index.html">
                            <i class="bi bi-diagram-3-fill" style='font-size: 1em;'></i>                            
                        </a>
                        <div class='dropdown'>
                            <button class="btn btn-warning dropdown-toggle" id="accountMenu" data-bs-toggle="dropdown" aria-expanded="false">My Account</button>
                            <ul class='dropdown-menu' aria-labelledby="accountMenu">
                                <li><a href='newOrder.html' id="newOrder" class='dropdown-item'>New Order</a></li>
                                <li><a href='orders.html' id="newOrder" class='dropdown-item'>Orders</a></li>
                                <li><a href='acceptedOrders.html' id="newOrder" class='dropdown-item'>Accepted Orders</a></li>
                                <li><a href='processingOrders.html' id="newOrder" class='dropdown-item active'>Processing Orders</a></li>
                                <li><a href='completedOrders.html' id="newOrder" class='dropdown-item'>Completed Orders</a></li>
                                <li><a href='stock.html' id="stock" class='dropdown-item'>Stock</a></li>
                                <li><a href='userAccounts.html' id="userAccount" class='dropdown-item'>User Accounts</a></li>
                                <li><a href='customers.html' id="customers" class='dropdown-item'>Customers</a></li>
                                <li><a href='transport.html' id="transport" class='dropdown-item'>Transport</a></li>
                                <li><a href='#' id="logout" class='dropdown-item'>logout</a></li>
                            </ul>    
                        </div>
                    </div>    
                </nav>
            </div>
        </div>
        <div>
            <div class="container settingsMenu"><br>
                
                <div class='row justify-content-center'>                      
                    <div class='col-12 p-4'> 
                        <h1 class="display-6">Customer Balancesheet</h1>    
                        <div id="userInventoryBlock"></div> 
                        
                        <table class="table table-condensed table-bordered" id="myTable">
                            <thead>
                              <tr>
                                <th scope="col">ProcessedOn</th>
                                <th scope="col">Id</th>
                                <th scope="col">Customer</th>
                                <th scope="col">Total</th>
                                <th scope="col">Paid</th>
                                <th scope="col">Pending</th>
                                <th scope="col">Pending Sofar</th>
                                <th scope="col">Status</th>

                              </tr>
                            </thead>
                            <tfoot>
                                <tr>
                                    <th scope="col">ProcessedOn</th>
                                    <th scope="col">Id</th>
                                    <th scope="col">Customer</th>
                                    <th scope="col">Total</th>
                                    <th scope="col">Paid</th>
                                    <th scope="col">Pending</th>
                                    <th scope="col">Pending Sofar</th>
                                    <th scope="col">Status</th>
                                </tr>
                            </tfoot>
                        </table><hr />
                        
                        <p>Actual Total : <b id="actualAmount"></b></p>
                        <p>Paid Amount : <b id="paidAmount"></b></p>
                        <p>Pending Total : <b id="pendingAmount"></b></p>
                        <p>Wallet Amount : <b id="walletAmount"></b></p>

                        <div class="input-group">
                            <input type="text" id="paying" class="form-control" placeholder="Enter Amount" />
                            <select id="modeOfPayment" class="form-control">
                                <option value="Cash">Cash</option>
                                <option value="Net Banking">Net Banking</option>
                                <option value="UPI">UPI</option>
                                <option value="Credit">Credit</option>
                                <option value="Wallet">Wallet</option>
                            </select>
                            <button id="updateAmount" class="btn btn-success">Update</button>
                        </div>    

                    </div>
                </div>
            </div>    
        </div>
    </div>

    <div class="position-fixed bottom-0 start-50 translate-middle-x p-3" style="z-index: 11">
      <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto"><i class="bi bi-exclamation-triangle"></i> Alert</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body"></div>
      </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script> 
    <script type='text/javascript' src='https://code.jquery.com/jquery-3.5.1.js'></script>

    <script src="js/init.js"></script>
    <script src="js/processingOrdersForIndividualUser.js"></script>

    <!-- <script type='text/javascript' src='https://code.jquery.com/jquery-3.5.1.js'></script>
    <script type='text/javascript' src='//cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js'></script> -->
    <!-- <link rel='stylesheet' href='//cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css'></link> -->
    <!-- <script type='text/javascript' src='https://cdn.datatables.net/select/1.3.4/js/dataTables.select.min.js'></script> -->


    <script type='text/javascript' src='https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js'></script> 
    <script type='text/javascript' src='https://cdn.datatables.net/select/1.3.4/js/dataTables.select.min.js'></script>
    <link rel='stylesheet' href='https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css'></link>
    <link rel='stylesheet' href='https://cdn.datatables.net/select/1.3.4/css/select.dataTables.min.css'></link>
    <script type="text/javascript">
        $(document).ready( function () {
            // loading data
           
          
            
            async function loadData(){
                $.ajax({
                type: 'POST',
                url: home.getProcessingOrdersUrl,
                contentType: "text/plain",
                dataType: 'json',
                data: JSON.stringify({id: home.getUrlParams('id')}),
                success: function (data) {
                    myJsonData = data;
                    
                    renderOrders(myJsonData).then(()=>{
                        let deleteItem = document.querySelectorAll('.deleteAccount');
                        deleteItem.forEach((item)=>{
                            item.addEventListener("click", async function(event){
                                event.preventDefault();
                                let id = event.target.getAttribute('data-id');
                                let table = home.table;
                                let del = await home.delete(id, table);
                                if( del.status ){
                                    event.target.parentNode.parentNode.style.display = "none";
                                    home.toaster("Deleted", true);
                                }else{
                                    home.toaster(del.msg, false);
                                }
                            });
                        });

                        let acceptItem = document.querySelectorAll('.complete');
                        acceptItem.forEach((item)=>{
                            item.addEventListener("click", async function(event){
                                event.preventDefault();
                                let id = event.target.getAttribute('data-id');                               
                                let table = home.table;
                                let complete = await home.completeOrder(id, table);
                                if( complete.status ){
                                    event.target.parentNode.parentNode.style.display = "none";
                                    home.toaster(complete.msg, true);
                                }else{
                                    home.toaster(complete.msg, false);
                                }
                            });
                        });
                    });
                },
                error: function (e) {
                    console.log("There was an error with your request...");
                    console.log("error: " + JSON.stringify(e));
                }
                });
            }
            
            async function getTotalPaymentsOfBill(paidInfo){
                
                let pInfo = JSON.parse(paidInfo);
                    let payments = 0;
                    pInfo.map((pInf)=>{
                        payments = payments + parseFloat(pInf.payment);

                    });
                    
                    return payments;
            }
            function procesingPaidMoneySoFar(){
                let paidSoFar = 0;
                async function addPayment(paidInfo){
                    let payments = await getTotalPaymentsOfBill(paidInfo);
                    return paidSoFar + payments;
                }
                return addPayment;                
            }

            // rendering data
            
            function tallyPaid(tPaid){
                let paid = tPaid; //5000
                function tally(total){ 
                    console.log(paid + "-" + total);
                    if( paid > total ){
                        paid = paid - total;
                        return {status: true};
                    }else{                        
                        if( total == paid ){
                            let obj = {status: false, paid:paid, pending:0};                            
                            paid = 0;
                            return obj
                        }else{
                            pending = total-paid;    
                            let obj = {status: false, paid:paid, pending:pending};     
                            paid = 0;                       
                            return obj;
                        }
                    }
                }
                return tally;
            }
            
            async function renderOrders(data){
                let tP = tallyPaid(home.getPaidAmount());
                var length = data.length;
                let customerTotal = 0;
                let totalPaidSoFarIndividual = 0;
                for(var i = 0; i < length; i++) {
                    let individualStatus = "Pending";
                    let individualPaidTotal1 = 0;
                    let individualPendingTotal = 0;

                    var inventory = data[i];
                    console.log("Inventory ", inventory);
                    $('#updateAmount').attr('customerId', inventory.customerId);
                    $('#updateAmount').attr('wallet', inventory.walletAmount);
                    $('#walletAmount').text(inventory.walletAmount);
                    let processingPaidMoney = 0;
                    if( inventory.paid ){
                        const gpmsf = await procesingPaidMoneySoFar();
                        processingPaidMoney = await gpmsf(inventory.paid);
                    }
                    // getTotalPaymentsOfBill(inventory.paid);
                    // console.log(inventory);
                    
                    let individualPaidTotal = inventory.paid ? await getTotalPaymentsOfBill(inventory.paid) : 0;

                    let final = 0;
                    inventory.product && inventory.product.map((pro)=>{
                        let gst = parseFloat(((pro[5] * 18)/118).toFixed(2));
                        let rate = pro[5] - gst;
                        let price = rate + gst;
                        let amount = pro[5]*pro[7];
                        let cgst = (gst/2).toFixed(2);                       
                        final += amount;
                    });
                    customerTotal = customerTotal + final
                    let totalPaidAmount = 0;
                    inventory.paid && JSON.parse(inventory.paid).map((row, index)=>{
                        totalPaidAmount += parseFloat(row['payment']);                       
                    });   
                    
                    // $("#paidAmount").text(totalPaidAmount && (parseFloat(totalPaidAmount) > parseFloat(final) ? final : totalPaidAmount));
                    let tobePaid = final - totalPaidAmount;
                    home.tobePaid = tobePaid;
                    
                    // check if total amount paid for the bill

                    if( final < home.getPaidAmount() ){
                        individualPaidTotal = final
                    }
                    
                    let tPStatus = await tP(final);
                    if( tPStatus.status ){
                        individualStatus = "Completed";
                        individualPaidTotal1 = final;
                        individualPendingTotal = 0
                    }else{
                        individualStatus = "Pending";
                        individualPaidTotal = tPStatus.paid;
                        individualPendingTotal = final - tPStatus.paid;
                    }

                    totalPaidSoFarIndividual = parseFloat(totalPaidSoFarIndividual) + parseFloat(individualPaidTotal);

                    $('#myTable').dataTable().fnAddData( [
                        inventory.processedOn,
                        inventory.id,
                        inventory.customer,
                        final,
                        individualPaidTotal,
                        individualPendingTotal,
                        individualPendingTotal <=0 ? 0 : customerTotal-totalPaidSoFarIndividual,
                        individualStatus
                    ]);
                }   
                $("#actualAmount").text(customerTotal); 
                $("#pendingAmount").text(customerTotal - home.totalPaidAmount);

                document.getElementById("paidAmount").innerHTML = home.totalPaidAmount;
            }

            $(document).on('click', '#button', function(){
                let dta = table.rows({ selected: true }).data();               
                let dtaArray = dta.toArray();
                var data = table.$('input').serialize();
                let newdtaArray = dtaArray;
                for(let i=0; i<dtaArray.length; i++){
                    newdtaArray[i][7] = table.$(`#qty_${newdtaArray[i][1]}`).val()
                }                
            });

            let table = $('#myTable').DataTable( {
                columnDefs: [ {
                    orderable: false,
                    // className: 'select-checkbox',
                    targets:0
                } ],
                select: {
                    style:'multi',
                    selector: 'td:first-child'
                },
                order: [[ 1, 'asc' ]],
                pageLength: 50,
                paging: false
            });

            $('#updateAmount').click(async function(ele){
                let paying = $('#paying').val();
                let modeOfPayment = $('#modeOfPayment').val();
                let customerId = home.getUrlParams("id");
                
                // let walletAmount = $(this).attr('wallet');
                let walletAmount = 0;
                let id = home.getUrlParams('id');
                if( modeOfPayment == "Wallet" ){                   
                    if(parseFloat(paying) > parseFloat(walletAmount)) {
                        alert("Wallet amount is not sufficient");
                        exit();
                    } 
                    if(parseFloat(paying) > parseFloat(home.tobePaid) ) {
                        alert("You cant give more than pending amount in wallet");
                        exit();
                    }    
                }
                if(parseFloat(paying) <= parseFloat(home.tobePaid)) {
                    let payingOrder = await home.payingForCustomer(id, home.table, paying, modeOfPayment, walletAmount, customerId);                    
                    if( payingOrder.status ){
                        home.toaster(payingOrder.msg, true);
                    }else{
                        home.toaster(payingOrder.msg, false);
                    }
                }else{
                    if(confirm("Add exceeded amount to Wallet ?")){
                        let payingOrder = await home.payingOrder(id, home.table, paying, modeOfPayment, walletAmount, customerId, home.tobePaid);
                        if( payingOrder.status ){
                            home.toaster(payingOrder.msg, true);
                        }else{
                            home.toaster(payingOrder.msg, false);
                        }
                    }
                }
            });

            loadData();
            
        } );
    </script>
</body>
</html>